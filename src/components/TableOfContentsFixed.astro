---
const { headings = [] } = Astro.props;

const filtered = (headings || []).filter(h => h && (h.depth === 2 || h.depth === 3));

const slugify = (s) =>
  String(s || '')
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');

const groups = [];
let cur = null;
for (const h of filtered) {
  if (h.depth === 2) { cur = { h2: h, h3s: [] }; groups.push(cur); }
  else if (h.depth === 3 && cur) { cur.h3s.push(h); }
}
---

{groups.length > 0 && (
  <nav class="toc-sidebar" aria-label="Table of contents">
    <div class="toc-header">Table of Contents</div>
    <ul class="toc-list">
      {groups.map((g) => {
        const id = slugify(g.h2.text);
        return (
          <li class="toc-item toc-level-2">
            <div class="toc-heading-row">
              <button class="toc-heading-btn" data-section={id} type="button" aria-expanded="false">
                <span class="toc-toggle-icon" aria-hidden>{g.h3s.length ? 'â–¶' : ''}</span>
                <a class="toc-link" data-target={id} href={`#${id}`}>{g.h2.text}</a>
              </button>
            </div>

            {g.h3s.length > 0 && (
              <ul class="toc-sublist" id={`sublist-${id}`} aria-hidden="true">
                {g.h3s.map(h3 => (
                  <li class="toc-item toc-level-3">
                    <a class="toc-link" data-target={slugify(h3.text)} href={`#${slugify(h3.text)}`}>{h3.text}</a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        );
      })}
    </ul>
  </nav>
)}

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const closeAll = () => {
    document.querySelectorAll('.toc-sublist').forEach(s => { s.classList.remove('open'); s.setAttribute('aria-hidden','true'); });
    document.querySelectorAll('.toc-heading-btn').forEach(b => b.classList.remove('expanded'));
    document.querySelectorAll('.toc-link').forEach(a => a.classList.remove('active'));
  };

  const openSection = (id, active) => {
    closeAll();
    const sub = document.getElementById('sublist-' + id);
    const btn = document.querySelector(`[data-section="${id}"]`);
    if (sub && btn) { sub.classList.add('open'); sub.setAttribute('aria-hidden','false'); btn.classList.add('expanded'); }
    if (active) {
      const link = document.querySelector(`.toc-link[data-target="${active}"]`);
      if (link) link.classList.add('active');
    }
  };

  document.addEventListener('click', (e) => {
    const a = e.target.closest('.toc-link');
    if (!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-target');
    const el = document.getElementById(id);
    if (el) window.scrollTo({ top: el.offsetTop - 90, behavior: 'smooth' }); else window.location.hash = id;
    const h2s = Array.from(document.querySelectorAll('h2'));
    let parent = null;
    for (let i = h2s.length - 1; i >= 0; i--) { if (h2s[i].offsetTop <= (el ? el.offsetTop : window.scrollY)) { parent = h2s[i]; break; } }
    if (parent) openSection(parent.id, id);
  });

  const obs = new IntersectionObserver((entries) => {
    entries.forEach(ent => {
      if (!ent.isIntersecting) return;
      const el = ent.target;
      if (el.tagName === 'H2') openSection(el.id, null);
      if (el.tagName === 'H3') {
        const h2s = Array.from(document.querySelectorAll('h2'));
        let parent = null;
        for (let i = h2s.length - 1; i >= 0; i--) { if (h2s[i].offsetTop <= el.offsetTop) { parent = h2s[i]; break; } }
        if (parent) openSection(parent.id, el.id);
      }
    });
  }, { root: null, rootMargin: '-40% 0px -40% 0px', threshold: 0 });

  document.querySelectorAll('h2, h3').forEach(h => obs.observe(h));
  closeAll();
});
</script>

<style>
  .toc-sidebar { position: sticky; top: 120px; width: 220px; max-height: calc(100vh - 140px); overflow-y: auto; padding-left: 1rem; margin-left: 2rem; font-size: .875rem; }
  .toc-header { font-weight: 700; color: rgb(16,185,129); margin-bottom: .75rem; font-size: .75rem; text-transform: uppercase; letter-spacing: .05em; }
  .toc-list { list-style: none; padding: 0; margin: 0; }
  .toc-item { margin: 0; padding: 0; }
  .toc-heading-row { display:flex; align-items:center; }
  .toc-heading-btn { display:flex; align-items:center; gap:.4rem; background:none; border:0; padding:0; width:100%; text-align:left; }
  .toc-toggle-icon { width:1rem; font-size:.75rem; color: rgb(16,185,129); transition: transform .2s ease; }
  .toc-heading-btn.expanded .toc-toggle-icon { transform: rotate(90deg); }
  .toc-link { color: rgb(148,163,184); text-decoration: none; display:block; padding:.35rem .5rem; border-radius:.25rem; transition: all .15s ease; border-left: 2px solid transparent; }
  .toc-heading-btn:hover .toc-link { color: rgb(16,185,129); background-color: rgba(16,185,129, .06); border-left-color: rgb(16,185,129); }
  .toc-sublist { list-style:none; padding:0; margin:0; margin-top:.25rem; max-height:0; overflow:hidden; transition: max-height .28s ease, opacity .28s ease; opacity:0 }
  .toc-sublist.open { max-height: 500px; opacity:1 }
  .toc-level-3 { margin-left: 1.1rem; margin-bottom:.25rem }
  .toc-level-3 .toc-link { color: rgb(100,116,139); font-size:.8rem; padding:.25rem .4rem }
  .toc-level-3 .toc-link:hover { color: rgb(16,185,129); background-color: rgba(16,185,129,.06); }
  .toc-link.active { color: rgb(59,130,246); font-weight:700 }
  @media (max-width: 1400px) { .toc-sidebar { display:none } }
</style>
